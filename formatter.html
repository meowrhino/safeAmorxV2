<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Amorx ¬∑ editor de contenido</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============================================================================
       ESTILOS (versi√≥n compacta)
       ============================================================================ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --color-bg: #f7f3ec;
      --color-surface: #ffffff;
      --color-border: #e4dcd3;
      --color-text: #1d1511;
      --color-muted: #6f6259;
      --color-strong: #0f0c0a;
      --color-soft: #fcfaf7;
      --radius: 12px;
      --shadow: 0 12px 32px rgba(0, 0, 0, 0.05);
      --font-main: 'Archivo', sans-serif;
    }
    body { font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); min-height: 100vh; line-height: 1.5; }
    .formatter-header { display: flex; align-items: flex-end; justify-content: space-between; gap: 12px; padding: 28px 32px 18px; border-bottom: 1px solid var(--color-border); background: var(--color-bg); }
    .title-block h1 { font-size: 1.8rem; letter-spacing: -0.02em; font-weight: 600; color: var(--color-strong); }
    .eyebrow { text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.85rem; color: var(--color-muted); margin-bottom: 4px; }
    .tabs { display: flex; gap: 8px; padding: 0 32px 16px; border-bottom: 1px solid var(--color-border); background: var(--color-bg); flex-wrap: wrap; }
    .tab { background: transparent; border: none; padding: 10px 14px; cursor: pointer; color: var(--color-muted); border-bottom: 2px solid transparent; font-size: 1rem; text-transform: lowercase; display: inline-flex; align-items: center; gap: 8px; transition: color 0.2s ease, border-color 0.2s ease; }
    .tab:hover { color: var(--color-text); }
    .tab.active { color: var(--color-text); border-bottom-color: var(--color-strong); }
    .tab-count { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 999px; padding: 2px 8px; font-size: 0.85rem; color: var(--color-muted); }
    .formatter-main { display: grid; grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr); gap: 24px; padding: 24px 32px 32px; }
    .editor-panel, .preview-panel { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: var(--shadow); }
    .panel-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; padding: 18px 20px 12px; border-bottom: 1px solid var(--color-border); }
    .panel-header h2 { font-size: 1.25rem; font-weight: 600; letter-spacing: -0.01em; margin-top: 2px; }
    .panel-actions { display: flex; gap: 10px; align-items: center; }
    .sections-container, .preview-container { padding: 18px 20px 24px; overflow-y: auto; }
    .section-card { background: transparent; border: none; border-radius: 0; padding: 0; margin-bottom: 28px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
    .section-number { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-muted); }
    .section-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .indent-control { display: inline-flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--color-muted); }
    .indent-label { text-transform: uppercase; letter-spacing: 0.06em; font-size: 0.75rem; }
    .indent-range { width: 120px; accent-color: var(--color-strong); }
    .indent-value { font-variant-numeric: tabular-nums; color: var(--color-strong); min-width: 3ch; text-align: right; }
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95rem; color: var(--color-muted); }
    .form-label.optional::after { content: ""; }
    .form-input, .form-textarea { width: 100%; border: 1px solid var(--color-border); border-radius: 10px; padding: 10px 12px; font-size: 1rem; font-family: var(--font-main); background: var(--color-surface); color: var(--color-text); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--color-strong); box-shadow: 0 0 0 2px rgba(15, 12, 10, 0.08); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .paragraph-list, .logo-list { display: flex; flex-direction: column; gap: 10px; }
    .block-list { display: flex; flex-direction: column; gap: 12px; }
    .block-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; }
    .block-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 10px; flex-wrap: wrap; }
    .block-label { font-size: 0.9rem; color: var(--color-muted); }
    .paragraph-item { background: transparent; border: none; border-radius: 0; padding: 0; }
    .logo-item { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; }
    .paragraph-item .form-textarea { border-radius: 0; border: 0; background: transparent; }
    .paragraph-header, .logo-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; gap: 8px; }
    .paragraph-label, .logo-label { font-size: 0.9rem; color: var(--color-muted); }
    .paragraph-actions { display: flex; gap: 6px; align-items: center; }
    .logo-fields { display: flex; flex-direction: column; gap: 10px; }
    .toggle-row { display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: var(--color-muted); }
    .toggle-row input { width: 18px; height: 18px; accent-color: var(--color-strong); }
    .image-list { display: flex; flex-direction: column; gap: 10px; }
    .image-item { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; }
    .image-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .image-label { font-size: 0.9rem; color: var(--color-muted); }
    .image-fields { display: flex; flex-direction: column; gap: 10px; }
    .btn { border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text); border-radius: 10px; padding: 10px 14px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; }
    .btn:hover { background: #f0ebe4; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
    .btn:disabled:hover { background: var(--color-surface); }
    .btn.solid { background: transparent; color: var(--color-strong); border: none; }
    .btn.solid:hover { background: #f0ebe4; }
    .btn.ghost { background: transparent; }
    .btn-small { padding: 8px 12px; font-size: 0.95rem; }
    .btn-icon { padding: 6px 10px; }
    .btn-add { width: 100%; border: none; color: var(--color-muted); background: transparent; }
    .btn-add:hover { background: #f0ebe4; color: var(--color-text); }
    .btn-add-block { font-weight: 700; }
    .btn-add-inline { width: auto; padding: 8px 10px; }
    .block-actions-row { display: flex; gap: 10px; margin-top: 10px; }
    .btn-danger { border-color: #d33643; color: #d33643; }
    .btn-danger:hover { background: rgba(211, 54, 67, 0.08); }
    .preview-container { background: var(--color-surface); }
    .preview-section { padding-bottom: 18px; margin-bottom: 18px; border-bottom: 1px solid var(--color-border); }
    .preview-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .preview-section h2 { font-size: 1.4rem; font-weight: 600; letter-spacing: -0.01em; margin-bottom: 4px; }
    .preview-section h3 { font-size: 1.05rem; font-weight: 600; color: var(--color-muted); margin-bottom: 8px; }
    .preview-section p { color: var(--color-text); margin-bottom: 10px; }
    .preview-block-header { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
    .preview-block-header h3 { margin-bottom: 0; }
    .preview-toggle { border: none; background: transparent; color: var(--color-muted); padding: 0; font-size: 0.9rem; line-height: 1; cursor: pointer; transition: transform 0.2s ease, opacity 0.2s ease; transform: rotate(-90deg); }
    .preview-block:not(.is-collapsed) .preview-toggle { transform: rotate(90deg); }
    .preview-toggle:hover { opacity: 0.8; }
    .preview-paragraphs { max-height: var(--preview-max-height, 9999px); overflow: hidden; opacity: 1; transform: translateY(0); transition: max-height 0.25s ease, opacity 0.2s ease, transform 0.25s ease; }
    .preview-block.is-collapsed .preview-paragraphs { max-height: 0; opacity: 0; transform: translateY(-4px); pointer-events: none; }
    .preview-block + .preview-block { margin-top: 12px; }
    .preview-block { --preview-paragraph-indent: 0; }
    .preview-paragraphs p { margin-left: var(--preview-paragraph-indent); }
    .preview-images { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    .preview-image-item { border: none; background: transparent; padding: 0; cursor: zoom-in; }
    .preview-image-thumb { width: 100%; display: block; border-radius: 8px; border: 1px solid var(--color-border); }
    .preview-logos { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .preview-logo { border: 1px solid var(--color-border); border-radius: 8px; padding: 6px 10px; background: var(--color-soft); color: var(--color-muted); font-size: 0.95rem; }
    .preview-lightbox { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index: 20; padding: 20px; }
    .preview-lightbox.is-visible { opacity: 1; pointer-events: auto; }
    .preview-lightbox-image { max-width: min(92vw, 900px); max-height: 90vh; object-fit: contain; border-radius: 10px; box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4); }
    .formatter-footer { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; padding: 16px 32px 28px; border-top: 1px solid var(--color-border); background: var(--color-bg); }
    .footer-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .footer-actions.footer-left { justify-content: flex-start; }
    .footer-actions.footer-center { justify-content: center; }
    .status-message { min-height: 1.2em; color: var(--color-muted); justify-self: end; }
    .status-message.success { color: #1f7a4c; }
    .status-message.error { color: #c0392b; }
    .status-message.warning { color: #c28418; }
    .empty-state { text-align: center; color: var(--color-muted); padding: 18px; background: var(--color-soft); border: 1px dashed var(--color-border); border-radius: 10px; }
    .sections-container::-webkit-scrollbar, .preview-container::-webkit-scrollbar { width: 8px; }
    .sections-container::-webkit-scrollbar-thumb, .preview-container::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 10px; }
    .sections-container::-webkit-scrollbar-track, .preview-container::-webkit-scrollbar-track { background: transparent; }
    @media (max-width: 1024px) { .formatter-main { grid-template-columns: 1fr; } .preview-panel { order: 2; } }
    @media (max-width: 768px) {
      .formatter-header, .formatter-footer { padding-left: 20px; padding-right: 20px; }
      .tabs { padding: 0 20px 14px; }
      .formatter-main { padding: 20px; gap: 18px; }
      .panel-header { flex-direction: column; align-items: flex-start; }
      .formatter-footer { grid-template-columns: 1fr; justify-items: center; }
      .footer-actions.footer-left,
      .footer-actions.footer-center { justify-content: center; }
      .status-message { justify-self: center; }
    }
  </style>
</head>
<body>
  <header class="formatter-header">
    <div class="title-block">
      <p class="eyebrow">safe amorx</p>
      <h1>editor de contenido</h1>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-category="about">about <span class="tab-count" id="count-about">0</span></button>
    <button class="tab" data-category="booking">booking <span class="tab-count" id="count-booking">0</span></button>
    <button class="tab" data-category="collabs">collabs <span class="tab-count" id="count-collabs">0</span></button>
    <button class="tab" data-category="training">training <span class="tab-count" id="count-training">0</span></button>
  </nav>

  <main class="formatter-main">
    <section class="editor-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">categor√≠a</p>
          <h2 id="categoryTitle">About</h2>
        </div>
        <button id="addSectionBtn" class="btn solid">+ a√±adir secci√≥n</button>
      </div>
      <div id="sectionsContainer" class="sections-container"></div>
    </section>

    <section class="preview-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">vista previa</p>
          <h2>Contenido</h2>
        </div>
      </div>
      <div id="previewContainer" class="preview-container"></div>
    </section>
  </main>

  <footer class="formatter-footer">
    <div class="footer-actions footer-left">
      <button id="saveBtn" class="btn ghost">Guardar local</button>
      <button id="resetLocalBtn" class="btn btn-danger">Limpiar local</button>
    </div>
    <div class="footer-actions footer-center">
      <button id="copyJsonBtn" class="btn ghost">Copiar JSON</button>
      <button id="downloadBtn" class="btn solid">Descargar data.json</button>
    </div>
    <span class="status-message" id="statusMessage"></span>
  </footer>

  <script>
    // ============================================================================
    // storage.js (embebido)
    // ============================================================================
    const Storage = {
      STORAGE_KEY: 'safeamorx_content_data',

      save(data) {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
          return true;
        } catch (error) {
          console.error('Error al guardar en LocalStorage:', error);
          return false;
        }
      },

      load() {
        try {
          const data = localStorage.getItem(this.STORAGE_KEY);
          const parsed = data ? JSON.parse(data) : null;
          return this.normalize(parsed);
        } catch (error) {
          console.error('Error al cargar desde LocalStorage:', error);
          return null;
        }
      },

      clear() {
        try {
          localStorage.removeItem(this.STORAGE_KEY);
          return true;
        } catch (error) {
          console.error('Error al limpiar LocalStorage:', error);
          return false;
        }
      },

      export(data, filename = 'data.json') {
        try {
          const jsonString = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          return true;
        } catch (error) {
          console.error('Error al exportar JSON:', error);
          return false;
        }
      },

      import(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const parsed = JSON.parse(event.target.result);
              const normalized = this.normalize(parsed);
              if (!normalized || !this.validate(normalized)) {
                reject(new Error('El archivo JSON no tiene la estructura correcta'));
                return;
              }
              resolve(normalized);
            } catch (error) {
              reject(new Error('Error al parsear el archivo JSON: ' + error.message));
            }
          };
          reader.onerror = () => reject(new Error('Error al leer el archivo'));
          reader.readAsText(file);
        });
      },

      validate(data) {
        const normalized = this.normalize(data);
        if (!normalized) return false;
        return ['about', 'booking', 'collabs', 'training'].every((category) => Array.isArray(normalized[category]));
      },

      getEmptyStructure() {
        return { about: [], booking: [], collabs: [], training: [] };
      },

      async copyToClipboard(data) {
        try {
          const jsonString = JSON.stringify(data, null, 2);
          await navigator.clipboard.writeText(jsonString);
          return true;
        } catch (error) {
          console.error('Error al copiar al portapapeles:', error);
          return false;
        }
      },

      normalize(raw) {
        if (!raw || typeof raw !== 'object') return null;
        const data = JSON.parse(JSON.stringify(raw));
        if (!data.collabs && Array.isArray(data.cv)) {
          data.collabs = data.cv;
        }
        if (!data.collabs && Array.isArray(data.curriculum)) {
          data.collabs = data.curriculum;
        }
        if (data.cv) delete data.cv;
        if (data.curriculum) delete data.curriculum;
        const normalizeIndentValue = (value) => {
          if (typeof value === 'number' && Number.isFinite(value)) {
            return Math.min(50, Math.max(0, value));
          }
          if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) return 0;
            if (/^\d+(\.\d+)?%$/.test(trimmed) || /^\d+(\.\d+)?$/.test(trimmed)) {
              const parsed = Number.parseFloat(trimmed);
              if (Number.isFinite(parsed)) {
                return Math.min(50, Math.max(0, parsed));
              }
            }
          }
          return 0;
        };
        const normalizeSection = (section) => {
          if (!section || typeof section !== 'object') {
            return { titulo: '', bloques: [{ subtitulo: '', texto: [], desplegable: false, sangria: 0 }], imagenes: [], logos: [] };
          }
          const normalized = { ...section };
          const sectionIndent = normalizeIndentValue(normalized.sangria);
          delete normalized.sangria;
          normalized.imagenes = Array.isArray(normalized.imagenes)
            ? normalized.imagenes.map(image => ({
              src: typeof image.src === 'string' ? image.src : '',
              alt: typeof image.alt === 'string' ? image.alt : ''
            }))
            : [];
          normalized.logos = Array.isArray(normalized.logos)
            ? normalized.logos.map(logo => ({
              src: typeof logo.src === 'string' ? logo.src : '',
              link: typeof logo.link === 'string' ? logo.link : '',
              alt: typeof logo.alt === 'string' ? logo.alt : ''
            }))
            : [];
          if (!Array.isArray(normalized.bloques)) {
            const subtitulo = typeof normalized.subtitulo === 'string' ? normalized.subtitulo : '';
            const texto = Array.isArray(normalized.texto) ? normalized.texto : [];
            normalized.bloques = [{ subtitulo, texto, desplegable: false, sangria: sectionIndent }];
            delete normalized.subtitulo;
            delete normalized.texto;
          } else {
            normalized.bloques = normalized.bloques.map(block => ({
              subtitulo: typeof block.subtitulo === 'string' ? block.subtitulo : '',
              texto: Array.isArray(block.texto) ? block.texto : [],
              desplegable: typeof block.desplegable === 'boolean' ? block.desplegable : false,
              sangria: normalizeIndentValue(
                (typeof block.sangria === 'number' || typeof block.sangria === 'string') ? block.sangria : sectionIndent
              )
            }));
          }
          return normalized;
        };
        ['about', 'booking', 'collabs', 'training'].forEach((category) => {
          if (!Array.isArray(data[category])) data[category] = [];
          data[category] = data[category].map(normalizeSection);
        });
        return data;
      },

      async fetchFromRepo() {
        try {
          const response = await fetch('data.json', { cache: 'no-cache' });
          if (!response.ok) throw new Error(`Respuesta ${response.status}`);
          const json = await response.json();
          return this.normalize(json);
        } catch (error) {
          console.error('Error al cargar data.json del repo:', error);
          return null;
        }
      }
    };

    // ============================================================================
    // preview.js (embebido)
    // ============================================================================
    const Preview = {
      container: null,
      lightbox: null,
      lightboxKeyHandlerAttached: false,

      init() {
        this.container = document.getElementById('previewContainer');
      },

      render(categoryData) {
        if (!this.container) return;
        this.container.innerHTML = '';

        if (!categoryData || categoryData.length === 0) {
          this.container.innerHTML = '<p class="empty-state">No hay contenido para mostrar</p>';
          return;
        }

        categoryData.forEach((section, index) => {
          const sectionElement = this.createSectionPreview(section, index);
          this.container.appendChild(sectionElement);
        });

        requestAnimationFrame(() => this.refreshExpandableHeights());
      },

      setExpandableHeight(wrapper) {
        if (!wrapper) return;
        wrapper.style.setProperty('--preview-max-height', `${wrapper.scrollHeight}px`);
      },

      refreshExpandableHeights() {
        if (!this.container) return;
        this.container.querySelectorAll('.preview-paragraphs').forEach((wrapper) => {
          this.setExpandableHeight(wrapper);
        });
      },

      normalizeIndent(value) {
        if (value === null || value === undefined) return '';
        if (typeof value === 'number' && Number.isFinite(value)) {
          const clamped = Math.min(50, Math.max(0, value));
          return `${clamped}%`;
        }
        if (typeof value === 'string' && value.trim()) {
          const trimmed = value.trim();
          if (/^\d+(\.\d+)?%$/.test(trimmed) || /^\d+(\.\d+)?$/.test(trimmed)) {
            const parsed = Number.parseFloat(trimmed);
            if (Number.isFinite(parsed)) {
              const clamped = Math.min(50, Math.max(0, parsed));
              return `${clamped}%`;
            }
          }
        }
        return '';
      },

      ensureLightbox() {
        if (this.lightbox) return this.lightbox;
        const overlay = document.createElement('div');
        overlay.className = 'preview-lightbox';
        overlay.setAttribute('aria-hidden', 'true');

        const img = document.createElement('img');
        img.className = 'preview-lightbox-image';
        img.alt = '';
        overlay.appendChild(img);

        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) this.closeLightbox();
        });

        if (!this.lightboxKeyHandlerAttached) {
          document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') this.closeLightbox();
          });
          this.lightboxKeyHandlerAttached = true;
        }

        document.body.appendChild(overlay);
        this.lightbox = overlay;
        return overlay;
      },

      openLightbox(src, altText) {
        if (!src) return;
        const overlay = this.ensureLightbox();
        const img = overlay.querySelector('img');
        img.src = src;
        img.alt = altText || '';
        overlay.classList.add('is-visible');
        overlay.setAttribute('aria-hidden', 'false');
      },

      closeLightbox() {
        if (!this.lightbox) return;
        const img = this.lightbox.querySelector('img');
        img.src = '';
        img.alt = '';
        this.lightbox.classList.remove('is-visible');
        this.lightbox.setAttribute('aria-hidden', 'true');
      },

      createSectionPreview(section, index) {
        const div = document.createElement('div');
        div.className = 'preview-section';

        if (section.titulo) {
          const h2 = document.createElement('h2');
          h2.textContent = section.titulo;
          div.appendChild(h2);
        }

        const blocks = this.normalizeBlocks(section);
        blocks.forEach((block, blockIndex) => {
          const blockWrapper = document.createElement('div');
          blockWrapper.className = 'preview-block';
          const blockIndent = this.normalizeIndent(block.sangria);
          if (blockIndent) {
            blockWrapper.style.setProperty('--preview-paragraph-indent', blockIndent);
          }

          const paragraphsWrapper = document.createElement('div');
          paragraphsWrapper.className = 'preview-paragraphs';
          paragraphsWrapper.id = `preview-block-${index}-${blockIndex}`;

          let hasParagraphs = false;
          let hasHeader = false;
          block.texto.forEach(parrafo => {
            if (typeof parrafo === 'string' && parrafo.trim()) {
              const p = document.createElement('p');
              p.textContent = parrafo;
              paragraphsWrapper.appendChild(p);
              hasParagraphs = true;
            }
          });

          if (block.subtitulo && block.subtitulo.trim()) {
            const header = document.createElement('div');
            header.className = 'preview-block-header';
            const h3 = document.createElement('h3');
            h3.textContent = block.subtitulo;
            header.appendChild(h3);
            hasHeader = true;

            if (block.desplegable && hasParagraphs) {
              const toggle = document.createElement('button');
              toggle.type = 'button';
              toggle.className = 'preview-toggle';
              toggle.setAttribute('aria-expanded', 'false');
              toggle.setAttribute('aria-controls', paragraphsWrapper.id);
              toggle.setAttribute('aria-label', 'Expandir bloque');
              toggle.textContent = '>';

              toggle.addEventListener('click', () => {
                this.setExpandableHeight(paragraphsWrapper);
                const isCollapsed = blockWrapper.classList.toggle('is-collapsed');
                toggle.setAttribute('aria-expanded', String(!isCollapsed));
                toggle.setAttribute('aria-label', isCollapsed ? 'Expandir bloque' : 'Contraer bloque');
              });

              blockWrapper.classList.add('is-collapsed');
              header.appendChild(toggle);
            }

            blockWrapper.appendChild(header);
          }

          if (hasHeader || hasParagraphs) {
            if (hasParagraphs) {
              blockWrapper.appendChild(paragraphsWrapper);
            }
            div.appendChild(blockWrapper);
          }
        });

        if (section.imagenes && Array.isArray(section.imagenes) && section.imagenes.length > 0) {
          const imagesDiv = document.createElement('div');
          imagesDiv.className = 'preview-images';

          section.imagenes.forEach(image => {
            if (!image || !image.src) return;
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'preview-image-item';

            const img = document.createElement('img');
            img.src = image.src;
            img.alt = image.alt || '';
            img.loading = 'lazy';
            img.decoding = 'async';
            img.className = 'preview-image-thumb';

            item.appendChild(img);
            item.addEventListener('click', () => this.openLightbox(image.src, image.alt || ''));
            imagesDiv.appendChild(item);
          });

          if (imagesDiv.children.length > 0) {
            div.appendChild(imagesDiv);
          }
        }

        if (section.logos && Array.isArray(section.logos) && section.logos.length > 0) {
          const logosDiv = document.createElement('div');
          logosDiv.className = 'preview-logos';

          section.logos.forEach(logo => {
            if (logo.src) {
              const logoContainer = document.createElement('div');
              logoContainer.className = 'preview-logo';
              logoContainer.textContent = `üñºÔ∏è ${logo.alt || 'Logo'}`;
              logosDiv.appendChild(logoContainer);
            }
          });

          div.appendChild(logosDiv);
        }
        return div;
      },

      normalizeBlocks(section) {
        if (Array.isArray(section.bloques)) {
          return section.bloques.map(block => ({
            subtitulo: typeof block.subtitulo === 'string' ? block.subtitulo : '',
            texto: Array.isArray(block.texto)
              ? block.texto
              : (typeof block.texto === 'string' ? [block.texto] : []),
            desplegable: typeof block.desplegable === 'boolean' ? block.desplegable : false,
            sangria: (typeof block.sangria === 'number' || typeof block.sangria === 'string') ? block.sangria : 0
          }));
        }

        const subtitulo = typeof section.subtitulo === 'string' ? section.subtitulo : '';
        const texto = Array.isArray(section.texto)
          ? section.texto
          : (typeof section.texto === 'string' ? [section.texto] : []);

        return [{ subtitulo, texto, desplegable: false, sangria: 0 }];
      },

      clear() {
        if (this.container) this.container.innerHTML = '';
      }
    };

    // ============================================================================
    // editor.js (embebido)
    // ============================================================================
    const Editor = {
      container: null,
      currentCategory: 'about',
      data: null,

      init(data) {
        this.container = document.getElementById('sectionsContainer');
        this.data = data || Storage.getEmptyStructure();
      },

      renderCategory(category) {
        this.currentCategory = category;
        this.container.innerHTML = '';
        const sections = this.data[category] || [];

        if (sections.length === 0) {
          this.container.innerHTML = '<p class="empty-state">No hay secciones. Pulsa "+ a√±adir secci√≥n" para empezar.</p>';
          return;
        }

        sections.forEach((section, index) => {
          const sectionCard = this.createSectionCard(section, index);
          this.container.appendChild(sectionCard);
        });
      },

      createSectionCard(section, index) {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.dataset.index = index;

        const header = document.createElement('div');
        header.className = 'section-header';
        const label = document.createElement('span');
        label.className = 'section-number';
        label.textContent = `Secci√≥n #${index + 1}`;
        header.appendChild(label);

        const actions = document.createElement('div');
        actions.className = 'section-actions';

        const moveUpBtn = document.createElement('button');
        moveUpBtn.className = 'btn btn-icon btn-small';
        moveUpBtn.title = 'Mover arriba';
        moveUpBtn.textContent = '‚Üë';
        moveUpBtn.disabled = index === 0;
        moveUpBtn.addEventListener('click', () => this.moveSection(index, -1));
        actions.appendChild(moveUpBtn);

        const moveDownBtn = document.createElement('button');
        moveDownBtn.className = 'btn btn-icon btn-small';
        moveDownBtn.title = 'Mover abajo';
        moveDownBtn.textContent = '‚Üì';
        moveDownBtn.disabled = index === this.data[this.currentCategory].length - 1;
        moveDownBtn.addEventListener('click', () => this.moveSection(index, 1));
        actions.appendChild(moveDownBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-icon btn-small btn-danger';
        deleteBtn.title = 'Eliminar secci√≥n';
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.addEventListener('click', () => this.deleteSection(index));
        actions.appendChild(deleteBtn);

        header.appendChild(actions);
        card.appendChild(header);

        card.appendChild(
          this.createFormGroup(
            '',
            'text',
            section.titulo || '',
            (value) => this.updateSection(index, 'titulo', value),
            false,
            'T√≠tulo'
          )
        );
        card.appendChild(this.createBlocksGroup(section, index));
        card.appendChild(this.createImagesGroup(section.imagenes || [], index));
        card.appendChild(this.createLogosGroup(section.logos || [], index));
        return card;
      },

      createFormGroup(label, type, value, onChange, optional = false, placeholder = '') {
        const group = document.createElement('div');
        group.className = 'form-group';
        const labelEl = document.createElement('label');
        labelEl.className = 'form-label' + (optional ? ' optional' : '');
        labelEl.textContent = label;
        group.appendChild(labelEl);

        const input = document.createElement(type === 'textarea' ? 'textarea' : 'input');
        input.className = type === 'textarea' ? 'form-textarea' : 'form-input';
        if (type !== 'textarea') input.type = type;
        if (placeholder) input.placeholder = placeholder;
        input.value = value;
        input.addEventListener('input', (e) => onChange(e.target.value));
        group.appendChild(input);
        return group;
      },

      normalizeIndentValue(value) {
        if (typeof value === 'number' && Number.isFinite(value)) {
          return Math.min(50, Math.max(0, value));
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          if (!trimmed) return 0;
          if (/^\d+(\.\d+)?%$/.test(trimmed) || /^\d+(\.\d+)?$/.test(trimmed)) {
            const parsed = Number.parseFloat(trimmed);
            if (Number.isFinite(parsed)) {
              return Math.min(50, Math.max(0, parsed));
            }
          }
        }
        return 0;
      },

      createIndentControl(value, onChange) {
        const control = document.createElement('label');
        control.className = 'indent-control';

        const label = document.createElement('span');
        label.className = 'indent-label';
        label.textContent = 'Sangr√≠a';

        const input = document.createElement('input');
        input.type = 'range';
        input.className = 'indent-range';
        input.min = '0';
        input.max = '50';
        input.step = '1';
        const initial = this.normalizeIndentValue(value);
        input.value = String(initial);

        const valueEl = document.createElement('span');
        valueEl.className = 'indent-value';
        valueEl.textContent = `${initial}%`;

        input.addEventListener('input', (event) => {
          const nextValue = Number(event.target.value);
          valueEl.textContent = `${nextValue}%`;
          onChange(nextValue);
        });

        control.appendChild(label);
        control.appendChild(input);
        control.appendChild(valueEl);
        return control;
      },

      createToggleGroup(label, checked, onChange) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const toggle = document.createElement('label');
        toggle.className = 'toggle-row';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !!checked;
        input.addEventListener('change', (e) => onChange(e.target.checked));

        const text = document.createElement('span');
        text.textContent = label;

        toggle.appendChild(input);
        toggle.appendChild(text);
        group.appendChild(toggle);
        return group;
      },

      createBlocksGroup(section, sectionIndex) {
        const blocks = this.normalizeBlocks(section);
        const group = document.createElement('div');
        group.className = 'form-group';

        const list = document.createElement('div');
        list.className = 'block-list';
        blocks.forEach((block, blockIndex) => {
          const item = this.createBlockCard(block, sectionIndex, blockIndex, blocks.length);
          list.appendChild(item);
        });
        group.appendChild(list);

        const addBlockBtn = document.createElement('button');
        addBlockBtn.className = 'btn btn-add btn-add-block';
        addBlockBtn.textContent = '+ A√±adir bloque';
        addBlockBtn.onclick = () => this.addBlock(sectionIndex, blocks.length - 1);
        group.appendChild(addBlockBtn);
        return group;
      },

      createBlockCard(block, sectionIndex, blockIndex, totalBlocks) {
        const card = document.createElement('div');
        card.className = 'block-card';

        const header = document.createElement('div');
        header.className = 'block-header';
        const label = document.createElement('span');
        label.className = 'block-label';
        label.textContent = `Bloque +${blockIndex + 1}`;
        header.appendChild(label);

        header.appendChild(
          this.createIndentControl(
            block.sangria || 0,
            (value) => this.updateBlockIndent(sectionIndex, blockIndex, value)
          )
        );

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-icon btn-small';
        deleteBtn.title = 'Eliminar bloque';
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.addEventListener('click', () => this.deleteBlock(sectionIndex, blockIndex));
        header.appendChild(deleteBtn);
        card.appendChild(header);

        card.appendChild(
          this.createFormGroup(
            '',
            'text',
            block.subtitulo || '',
            (value) => this.updateSubtitle(sectionIndex, blockIndex, value),
            true,
            'Subt√≠tulo'
          )
        );

        card.appendChild(
          this.createToggleGroup(
            'P√°rrafos desplegables',
            !!block.desplegable,
            (value) => this.updateBlockToggle(sectionIndex, blockIndex, value)
          )
        );

        card.appendChild(this.createParagraphsGroup(block.texto || [], sectionIndex, blockIndex));

        const actionsRow = document.createElement('div');
        actionsRow.className = 'block-actions-row';

        const addParagraphBtn = document.createElement('button');
        addParagraphBtn.className = 'btn btn-add btn-add-inline';
        addParagraphBtn.textContent = '+ A√±adir p√°rrafo';
        addParagraphBtn.onclick = () => this.addParagraph(sectionIndex, blockIndex);
        actionsRow.appendChild(addParagraphBtn);

        if (blockIndex === totalBlocks - 1) {
          const addImageBtn = document.createElement('button');
          addImageBtn.className = 'btn btn-add btn-add-inline';
          addImageBtn.textContent = '+ A√±adir imagen';
          addImageBtn.onclick = () => this.addImage(sectionIndex);
          actionsRow.appendChild(addImageBtn);

          const addLogoBtn = document.createElement('button');
          addLogoBtn.className = 'btn btn-add btn-add-inline';
          addLogoBtn.textContent = '+ A√±adir logo';
          addLogoBtn.onclick = () => this.addLogo(sectionIndex);
          actionsRow.appendChild(addLogoBtn);
        }

        card.appendChild(actionsRow);

        return card;
      },

      createParagraphsGroup(paragraphs, sectionIndex, blockIndex) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const list = document.createElement('div');
        list.className = 'paragraph-list';
        paragraphs.forEach((paragraph, pIndex) => {
          const item = this.createParagraphItem(paragraph, sectionIndex, blockIndex, pIndex, paragraphs.length);
          list.appendChild(item);
        });
        group.appendChild(list);
        return group;
      },

      createParagraphItem(paragraph, sectionIndex, blockIndex, pIndex, totalParagraphs) {
        const item = document.createElement('div');
        item.className = 'paragraph-item';
        const header = document.createElement('div');
        header.className = 'paragraph-header';
        const label = document.createElement('span');
        label.className = 'paragraph-label';
        label.textContent = `P√°rrafo ${pIndex + 1}`;
        header.appendChild(label);

        const actions = document.createElement('div');
        actions.className = 'paragraph-actions';

        const moveUpBtn = document.createElement('button');
        moveUpBtn.className = 'btn btn-icon btn-small';
        moveUpBtn.title = 'Mover p√°rrafo arriba';
        moveUpBtn.textContent = '‚Üë';
        moveUpBtn.disabled = pIndex === 0;
        moveUpBtn.addEventListener('click', () => this.moveParagraph(sectionIndex, blockIndex, pIndex, -1));
        actions.appendChild(moveUpBtn);

        const moveDownBtn = document.createElement('button');
        moveDownBtn.className = 'btn btn-icon btn-small';
        moveDownBtn.title = 'Mover p√°rrafo abajo';
        moveDownBtn.textContent = '‚Üì';
        moveDownBtn.disabled = pIndex === totalParagraphs - 1;
        moveDownBtn.addEventListener('click', () => this.moveParagraph(sectionIndex, blockIndex, pIndex, 1));
        actions.appendChild(moveDownBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-icon btn-small';
        deleteBtn.title = 'Eliminar p√°rrafo';
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.addEventListener('click', () => this.deleteParagraph(sectionIndex, blockIndex, pIndex));
        actions.appendChild(deleteBtn);

        header.appendChild(actions);
        item.appendChild(header);

        const textarea = document.createElement('textarea');
        textarea.className = 'form-textarea';
        textarea.value = paragraph;
        textarea.addEventListener('input', (e) => this.updateParagraph(sectionIndex, blockIndex, pIndex, e.target.value));
        item.appendChild(textarea);
        return item;
      },

      createImagesGroup(images, sectionIndex) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const list = document.createElement('div');
        list.className = 'image-list';
        images.forEach((image, iIndex) => {
          const item = this.createImageItem(image, sectionIndex, iIndex);
          list.appendChild(item);
        });
        group.appendChild(list);
        return group;
      },

      createImageItem(image, sectionIndex, iIndex) {
        const item = document.createElement('div');
        item.className = 'image-item';
        const header = document.createElement('div');
        header.className = 'image-header';
        header.innerHTML = `
          <span class="image-label">Imagen ${iIndex + 1}</span>
          <button class="btn btn-icon btn-small" onclick="Editor.deleteImage(${sectionIndex}, ${iIndex})" title="Eliminar imagen">üóëÔ∏è</button>
        `;
        item.appendChild(header);

        const fields = document.createElement('div');
        fields.className = 'image-fields';

        const srcInput = document.createElement('input');
        srcInput.className = 'form-input';
        srcInput.type = 'text';
        srcInput.placeholder = 'URL de la imagen (src)';
        srcInput.value = image.src || '';
        srcInput.addEventListener('input', (e) => this.updateImage(sectionIndex, iIndex, 'src', e.target.value));
        fields.appendChild(srcInput);

        const altInput = document.createElement('input');
        altInput.className = 'form-input';
        altInput.type = 'text';
        altInput.placeholder = 'Texto alternativo (alt)';
        altInput.value = image.alt || '';
        altInput.addEventListener('input', (e) => this.updateImage(sectionIndex, iIndex, 'alt', e.target.value));
        fields.appendChild(altInput);

        item.appendChild(fields);
        return item;
      },

      createLogosGroup(logos, sectionIndex) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const list = document.createElement('div');
        list.className = 'logo-list';
        logos.forEach((logo, lIndex) => {
          const item = this.createLogoItem(logo, sectionIndex, lIndex);
          list.appendChild(item);
        });
        group.appendChild(list);
        return group;
      },

      createLogoItem(logo, sectionIndex, lIndex) {
        const item = document.createElement('div');
        item.className = 'logo-item';
        const header = document.createElement('div');
        header.className = 'logo-header';
        header.innerHTML = `
          <span class="logo-label">Logo ${lIndex + 1}</span>
          <button class="btn btn-icon btn-small" onclick="Editor.deleteLogo(${sectionIndex}, ${lIndex})" title="Eliminar logo">üóëÔ∏è</button>
        `;
        item.appendChild(header);

        const fields = document.createElement('div');
        fields.className = 'logo-fields';

        const srcInput = document.createElement('input');
        srcInput.className = 'form-input';
        srcInput.type = 'text';
        srcInput.placeholder = 'URL de la imagen (src)';
        srcInput.value = logo.src || '';
        srcInput.addEventListener('input', (e) => this.updateLogo(sectionIndex, lIndex, 'src', e.target.value));
        fields.appendChild(srcInput);

        const linkInput = document.createElement('input');
        linkInput.className = 'form-input';
        linkInput.type = 'text';
        linkInput.placeholder = 'URL del enlace (link)';
        linkInput.value = logo.link || '';
        linkInput.addEventListener('input', (e) => this.updateLogo(sectionIndex, lIndex, 'link', e.target.value));
        fields.appendChild(linkInput);

        const altInput = document.createElement('input');
        altInput.className = 'form-input';
        altInput.type = 'text';
        altInput.placeholder = 'Texto alternativo (alt)';
        altInput.value = logo.alt || '';
        altInput.addEventListener('input', (e) => this.updateLogo(sectionIndex, lIndex, 'alt', e.target.value));
        fields.appendChild(altInput);

        item.appendChild(fields);
        return item;
      },

      updateSection(index, field, value) {
        this.data[this.currentCategory][index][field] = value;
        this.triggerUpdate();
      },

      updateLogo(sectionIndex, lIndex, field, value) {
        if (!this.data[this.currentCategory][sectionIndex].logos) {
          this.data[this.currentCategory][sectionIndex].logos = [];
        }
        this.data[this.currentCategory][sectionIndex].logos[lIndex][field] = value;
        this.triggerUpdate();
      },

      updateImage(sectionIndex, iIndex, field, value) {
        if (!this.data[this.currentCategory][sectionIndex].imagenes) {
          this.data[this.currentCategory][sectionIndex].imagenes = [];
        }
        this.data[this.currentCategory][sectionIndex].imagenes[iIndex][field] = value;
        this.triggerUpdate();
      },

      normalizeBlocks(section) {
        const fallbackIndent = this.normalizeIndentValue(section.sangria);
        if (!Array.isArray(section.bloques) || section.bloques.length === 0) {
          const subtitulo = typeof section.subtitulo === 'string' ? section.subtitulo : '';
          const texto = Array.isArray(section.texto) ? section.texto : [];
          section.bloques = [{ subtitulo, texto, desplegable: false, sangria: fallbackIndent }];
          delete section.subtitulo;
          delete section.texto;
        }

        section.bloques = section.bloques.map(block => ({
          subtitulo: typeof block.subtitulo === 'string' ? block.subtitulo : '',
          texto: Array.isArray(block.texto) ? block.texto : [],
          desplegable: typeof block.desplegable === 'boolean' ? block.desplegable : false,
          sangria: this.normalizeIndentValue(
            (typeof block.sangria === 'number' || typeof block.sangria === 'string') ? block.sangria : fallbackIndent
          )
        }));

        if (section.bloques.length === 0) {
          section.bloques.push({ subtitulo: '', texto: [], desplegable: false, sangria: fallbackIndent });
        }

        return section.bloques;
      },

      updateSubtitle(sectionIndex, blockIndex, value) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].subtitulo = value;
        this.triggerUpdate();
      },

      updateBlockToggle(sectionIndex, blockIndex, value) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].desplegable = value;
        this.triggerUpdate();
      },

      updateBlockIndent(sectionIndex, blockIndex, value) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].sangria = this.normalizeIndentValue(value);
        this.triggerUpdate();
      },

      updateParagraph(sectionIndex, blockIndex, pIndex, value) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].texto[pIndex] = value;
        this.triggerUpdate();
      },

      addSection() {
        const newSection = { titulo: '', bloques: [{ subtitulo: '', texto: [], desplegable: false, sangria: 0 }], imagenes: [], logos: [] };
        this.data[this.currentCategory].push(newSection);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteSection(index) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar esta secci√≥n?')) {
          this.data[this.currentCategory].splice(index, 1);
          this.renderCategory(this.currentCategory);
          this.triggerUpdate();
        }
      },

      moveSection(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= this.data[this.currentCategory].length) return;
        const sections = this.data[this.currentCategory];
        [sections[index], sections[newIndex]] = [sections[newIndex], sections[index]];
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addBlock(sectionIndex, afterBlockIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        const insertAt = Math.min(afterBlockIndex + 1, blocks.length);
        blocks.splice(insertAt, 0, { subtitulo: '', texto: [], desplegable: false, sangria: 0 });
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteBlock(sectionIndex, blockIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks.splice(blockIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addParagraph(sectionIndex, blockIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].texto.push('');
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteParagraph(sectionIndex, blockIndex, pIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].texto.splice(pIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      moveParagraph(sectionIndex, blockIndex, pIndex, direction) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        const paragraphs = blocks[blockIndex].texto;
        const newIndex = pIndex + direction;
        if (newIndex < 0 || newIndex >= paragraphs.length) return;
        [paragraphs[pIndex], paragraphs[newIndex]] = [paragraphs[newIndex], paragraphs[pIndex]];
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addLogo(sectionIndex) {
        if (!this.data[this.currentCategory][sectionIndex].logos) {
          this.data[this.currentCategory][sectionIndex].logos = [];
        }
        this.data[this.currentCategory][sectionIndex].logos.push({ src: '', link: '', alt: '' });
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addImage(sectionIndex) {
        if (!this.data[this.currentCategory][sectionIndex].imagenes) {
          this.data[this.currentCategory][sectionIndex].imagenes = [];
        }
        this.data[this.currentCategory][sectionIndex].imagenes.push({ src: '', alt: '' });
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteLogo(sectionIndex, lIndex) {
        this.data[this.currentCategory][sectionIndex].logos.splice(lIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteImage(sectionIndex, iIndex) {
        this.data[this.currentCategory][sectionIndex].imagenes.splice(iIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      triggerUpdate() {
        if (window.Formatter && window.Formatter.onDataChange) window.Formatter.onDataChange();
      }
    };

    // ============================================================================
    // formatter.js (embebido)
    // ============================================================================
    const Formatter = {
      currentCategory: 'about',
      data: null,
      statusTimer: null,

      async init() {
        const stored = Storage.load();
        const storedRaw = localStorage.getItem(Storage.STORAGE_KEY);
        const storedHasSangria = storedRaw ? storedRaw.includes('"sangria"') : false;
        const storedHasDesplegable = storedRaw ? storedRaw.includes('"desplegable"') : false;
        let repoData = null;
        if (!stored) this.showStatus('Cargando data.json del repo...', '');

        try {
          repoData = await Storage.fetchFromRepo();
        } catch (error) {
          console.error('No se pudo leer data.json del repo', error);
          this.showStatus('No se pudo leer data.json del repo', 'error');
        }

        const normalizedStored = this.normalizeData(stored);
        const normalizedRepo = this.normalizeData(repoData);
        if (normalizedStored && normalizedRepo) {
          this.data = this.mergeMissingBlockFields(normalizedStored, normalizedRepo, {
            preferRepoSangria: !storedHasSangria,
            preferRepoDesplegable: !storedHasDesplegable
          });
          Storage.save(this.data);
        } else {
          this.data = normalizedStored || normalizedRepo || Storage.getEmptyStructure();
        }

        Editor.init(this.data);
        Preview.init();
        this.setupEventListeners();
        this.switchCategory(this.currentCategory);
        this.updateCounts();

        if (stored) {
          this.showStatus('Datos recuperados del guardado local', 'success');
        } else if (repoData) {
          this.showStatus('data.json cargado autom√°ticamente', 'success');
          Storage.save(this.data);
        } else {
          this.showStatus('Arrancamos con un esquema vac√≠o', 'warning');
        }
      },

      normalizeData(raw) {
        return Storage.normalize(raw);
      },

      mergeMissingBlockFields(stored, repo, options = {}) {
        if (!stored || !repo) return stored || repo;
        const { preferRepoSangria = false, preferRepoDesplegable = false } = options;
        const merged = JSON.parse(JSON.stringify(stored));
        const categories = ['about', 'booking', 'collabs', 'training'];
        categories.forEach((category) => {
          const storedSections = Array.isArray(merged[category]) ? merged[category] : [];
          const repoSections = Array.isArray(repo[category]) ? repo[category] : [];

          repoSections.forEach((repoSection, sectionIndex) => {
            if (!storedSections[sectionIndex]) {
              storedSections[sectionIndex] = repoSection;
              return;
            }
            const storedSection = storedSections[sectionIndex];
            if (!Array.isArray(storedSection.bloques) && Array.isArray(repoSection.bloques)) {
              storedSection.bloques = repoSection.bloques;
              return;
            }
            if (!Array.isArray(storedSection.bloques) || !Array.isArray(repoSection.bloques)) return;

            repoSection.bloques.forEach((repoBlock, blockIndex) => {
              if (!storedSection.bloques[blockIndex]) {
                storedSection.bloques[blockIndex] = repoBlock;
                return;
              }
              const storedBlock = storedSection.bloques[blockIndex];
              if (preferRepoDesplegable && repoBlock.desplegable !== undefined) {
                storedBlock.desplegable = repoBlock.desplegable;
              } else if (storedBlock.desplegable === undefined && repoBlock.desplegable !== undefined) {
                storedBlock.desplegable = repoBlock.desplegable;
              }

              if (preferRepoSangria && repoBlock.sangria !== undefined) {
                storedBlock.sangria = repoBlock.sangria;
              } else if (storedBlock.sangria === undefined && repoBlock.sangria !== undefined) {
                storedBlock.sangria = repoBlock.sangria;
              }
            });
          });

          merged[category] = storedSections;
        });

        return merged;
      },

      setupEventListeners() {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const category = e.currentTarget.dataset.category;
            this.switchCategory(category);
          });
        });

        document.getElementById('addSectionBtn').addEventListener('click', () => {
          Editor.addSection();
          this.updateCounts();
        });

        document.getElementById('saveBtn').addEventListener('click', () => this.saveProgress());
        document.getElementById('downloadBtn').addEventListener('click', () => this.downloadData());
        const resetLocalBtn = document.getElementById('resetLocalBtn');
        if (resetLocalBtn) resetLocalBtn.addEventListener('click', () => this.clearLocalAndReload());

        const copyBtn = document.getElementById('copyJsonBtn');
        if (copyBtn) copyBtn.addEventListener('click', () => this.copyJson());
      },

      switchCategory(category) {
        this.currentCategory = category;
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.category === category);
        });

        const categoryTitles = { about: 'About', booking: 'Booking', collabs: 'Collabs', training: 'Training' };
        document.getElementById('categoryTitle').textContent = categoryTitles[category] || category;

        if (!this.data[category]) this.data[category] = [];
        Editor.renderCategory(category);
        Preview.render(this.data[category]);
      },

      updateCounts() {
        ['about', 'booking', 'collabs', 'training'].forEach(category => {
          const count = this.data[category] ? this.data[category].length : 0;
          const countEl = document.getElementById(`count-${category}`);
          if (countEl) countEl.textContent = count;
        });
      },

      onDataChange() {
        Preview.render(this.data[this.currentCategory]);
        this.updateCounts();
        Storage.save(this.data);
      },

      saveProgress() {
        const success = Storage.save(this.data);
        this.showStatus(success ? 'Progreso guardado en este navegador' : 'No se pudo guardar el progreso', success ? 'success' : 'error');
      },

      downloadData() {
        const success = Storage.export(this.data, 'data.json');
        this.showStatus(success ? 'Descarga lista' : 'No se pudo generar el JSON', success ? 'success' : 'error');
      },

      async copyJson() {
        const success = await Storage.copyToClipboard(this.data);
        this.showStatus(success ? 'JSON copiado al portapapeles' : 'No se pudo copiar el JSON', success ? 'success' : 'error');
      },

      resetData() {
        if (confirm('¬øQuieres volver al data.json limpio? Se perder√°n los cambios sin guardar.')) {
          this.data = Storage.getEmptyStructure();
          Editor.data = this.data;
          Storage.clear();
          this.switchCategory(this.currentCategory);
          this.updateCounts();
          this.showStatus('Contenido reseteado', 'success');
        }
      },

      clearLocalAndReload() {
        if (!confirm('Se borrara el cache local y se recargara data.json. Continuar?')) return;
        Storage.clear();
        location.reload();
      },

      showStatus(message, type = '') {
        const statusEl = document.getElementById('statusMessage');
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.className = 'status-message ' + type;
        clearTimeout(this.statusTimer);
        this.statusTimer = setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'status-message';
        }, 3200);
      }
    };

    document.addEventListener('DOMContentLoaded', () => Formatter.init());
  </script>
</body>
</html>
